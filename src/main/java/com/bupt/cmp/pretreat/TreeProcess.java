package com.bupt.cmp.pretreat;


import com.bupt.cmp.ast.Node;
import com.bupt.cmp.ast.SimpleNode;
import com.bupt.cmp.lang.file.DefaultCodeFile;
import com.bupt.cmp.pretreat.format.StoreNode;

import java.util.Collections;
import java.util.List;

public class TreeProcess {
	/**
	 * 比对算法中所用到的hash值数组，固定值不变
	 */
	private int[] hashArrays = {47126554,43647816,17798518,89597671,55236056,488823,31999429,71422053,50696843,14520927,79039001,4086638,13454663,87598984,61986105,89058811,72189878,5581465,68301133,25583656,3374144,77413107,76747286,51036079,14882924,22152588,64656112,48112749,1975980,98005109,15900002,25539352,88619083,92600979,55010522,3899852,92021522,18537581,57812792,63220806,73200218,83428324,13987333,34004918,61622456,28553434,41907024,38294367,66600565,55278740,81178161,12435600,13573124,83309743,13265716,68188636,67928424,10054675,85584294,73795035,34442290,65086311,39462400,61680136,45138559,78978748,67343994,94416179,73436744,10546420,49667480,45564392,37552701,1714048,46738561,77065247,81009345,54097313,46064636,19827345,43095715,46475414,90464671,89101738,57278936,37262866,37449719,91349593,40329898,21164129,25135491,4192519,60174663,34085968,45184697,36105972,95244942,25528614,48103045,97517519,23347179,42523123,31339092,39897955,2801017,94323547,
			85504368,44529474,33874252,91893738,99166452,67596411,13277511,81489965,47583920,73175288,19713265,16291635,15773344,10887157,93324923,35373800,31289772,19676452,96913106,44071256,7133352,64561880,71857378,14910388,20136053,37801050,26602963,53281092,75293612,81286862,20633312,96877425,31314189,11669853,31745495,43196801,87901359,54932050,19656783,24123887,60080391,22048988,23651919,71786542,89967988,82352966,57331931,44842407,71421907,16206699,88256478,9256026,87898142,53757928,15373093,92842600,88959578,31231671,82187808,57560749,55796321,21558123,88483040,58842862,31154114,20895461,88554699,85972955,14048502,97708002,88791892,2773099,44728694,36041495,82538743,32630797,30131286,29613503,85089133,57105942,85405284,8448143,56746395,22147199,91721066,4515624,26791317,71193913,95887261,88263393,56302916,49170946,2065693,32411802,2677889,46620019,31085794,84903593,73740698,78027445,47606207,57467649,84402657,13569346,80662483,61513781,53639518,8336740,
			87871035,47996505,4788410,98224084,38775794,32887093,57021142,56641185,17640246,14874327,20832185,31139512,71153742,16955760,35540876,4105366,51377309,8552408,11548669,46698440,29385342,89776174,65418454,60145697,79915876,44530432,60504255,23511619,62503353,94015559,91135869,92147252,49414076,7367364,73184235,15881597,75820760,50977694,28919573,71170279,12583847,83207658,79080640,26267529,87043551,26120246,79964576,83653934,2192763,70815314,68563230,68753461,29642258,98111165,3447942,59179726,76780903,21118251,14511122,73562545,53479751,81396674,99274177,64192155,88735227,55305532,28727560,82539738,72722823,52258326,50630020,11809069,24523969,11384901,3075339,85710445,11015030,28416673,76276112,37554225,67283564,69288157,85440366,48797616,93908314,52158970,42608075,91209550,31615576,4506873,40395867,81794798,38555883,26918514,85474477,94594623,20691168,20200934,44694743,98532667,90678863,57463018,91794201,15415854,55575561,7852405,67482565,17266486,
			58824221,43514600,90905687,7097865,26865043,86447246,85288716,52282038,95811470,76933840,5690601,64659591,18538984,70117341,81778171,46522515,77555616,92415419,13464369,46597588,54139360,14375366,82311439,95213851,29033898,21672843,66641121,12754031,15155324,90800008,73180131,10526041,47638792,1169745,23155522,28251934,81710266,40258974,55720677,77237880,73689780,83350280,36644013,83410079,45513913,54667373,85083698,49402687,58286386,1381085,56402921,79685139,45051945,37233912,43856511,38072471,78389996,37417336,87110982,31613515,73060619,91242419,406276,40008063,49186929,44405382,58313762,34810386,6293928,87326209,1981307,57387702,83690296,71339455,53677452,49938463,7485775,59272782,52633001,58576578,49668108,42109968,49994579,52713933,49659654,78366338,25820935,29864822,73740172,37810901,15979094,99932139,12648374,56190643,61858590,68266474,42856248,32578752,20803381,61485445,1881276,26004721,87230,65296893,52937978,32975598,2419616,68430815,39481494,
			52593867,95805428,31791123,54847076,70833693,45643070,27049610,77575718,20668506,72011714,13720732,47602304,99669198,19984773,48927066,83903987,51733381,55862908,49016577,68847702,44562469,27266086,47049005,49686994,99529568,49910551,15465066,32619596,55607411,9002664,47918240,69743416,73951827,88133023,19535344,64344875,14832455,63540315,69663186,44894760,43488778,26680772,76289955,83123032,46645576,22950250,16226192,56620234,66193431,19452211,30281454,81269480,81820915,39731233,37469054,63994130,99141515,28357744,67462468,51132641,24974485,33221127,5388270,72873227,36450162,18434440,68131738,9152284,75551441,45810321,56282465,27351723,25749423,87648872,50863589,67226670,52352460,58914572,48974545,73476183,13239102,81515553,57493380,1285928,71576670,18709717,89011067,45267988,67208436,42458575,29076395,67199221,28338684,21630805,68936289,22935841,30096092,43958849,22902705,13878180,31747215,9633107,74503440,13425753,49048023,59434506,20490473,43719106,
			43487765,25242525,6970709,3196078,35015620,15921942,76630226,70226436,69896890,76332894,71379418,33280042,356722,82495006,59402585,22994981,57600572,60697685,80851924,46578325,24946951,43474835,31266939,49863451,42599138,378591,26906714,57469125,803880,6372825,21108595,66426716,2941301,35773521,65793209,93653271,5256526,94639266,37336865,2724357,64854741,29471477,70833774,60241837,52582685,75140092,71996629,97273004,12440807,29901835,780458,76178788,74206593,70424306,45875844,88304897,50840770,44710506,34218886,32846134,77384418,5749526,44656504,52310260,72946177,73920515,19931933,24999117,32425092,40868191,96051577,39830921,79620783,52874449,93315528,3943900,38393968,36571900,37980383,58497713,3426556,54881321,8829232,2960301,17376804,6046410,27739928,53394138,85876276,3720308,38393978,85032014,87221595,924760,42229708,34613801,58200215,45818909,85884533,62806876,62830723,82151060,19137458,2139113,75619387,32262965,67589174,40844645,35925946,25607399,
			89178362,17953777,55152889,60546109,8684061,30109795,83358708,12481424,49345224,75416517,66916836,26066080,5759819,84756831,53938307,54442052,27167089,15953599,28967344,33430455,5322831,11165625,83760362,3515818,85988824,42932612,55625138,17499256,48333735,99219273,90068133,96806383,21239159,82875030,9349201,24196967,30760626,25906972,93589171,85914676,97784685,43910015,6097044,1071435,30144471,81134403,19464794,1172189,78207300,21467026,24229017,47682171,48179226,65824166,26589896,584900,92172619,1269675,66909244,75675546,19299159,12288689,15585595,53625368,96766847,9593354,28015604,28664380,35305890,76853204,65182206,9695444,77884600,60759144,11596320,11884421,35997623,54761199,47185045,1432140,42595179,51931468,54795611,81595230,15793097,67314926,69925568,32719151,52559821,55147051,4350943,44242943,96412734,71328402,255351,1531502,48432378,56617616,96559343,15427447,15539506,40800452,14015385,7465856,15325985,93343867,90775318,88561440,81517007,70880243,
			25043206,94108956,39208153,36903232,6432835,63378885,44047213,54087868,42720377,76116718,4421847,74598888,13578900,84165358,30925478,78812433,7982777,1106467,82110003,37807543,26896192,37737797,765213,55158,57886233,96269812,59766009,27638494,53302324,61226141,61759790,32465022,68684987,49783678,61697640,87806451,42998141,9609364,6449140,15599394,27395485,76961969,10581960,74835638,94067625,33008404,12498566,1512210,81913014,21215384,79998662,75462651,60591874,13743483,59497251,14532162,19633652,39711874,87974381,21365596,14264671,13178327,11793998,33373399,24559063,23860241,81590463,51101996,9542119,78298781,17307647,45486256,62971627,4539395,62536676,69367963,2298876,58083309,72364720,23645501,47592377,92080734,3738407,53466136,71973460,79627900,2601764,74848603,30239311,1036183,6949775,57104903,97295141,34032868,9804906,11471507,73058493,9689387,51435247,61381374,35459917,22064034,34819104,94654456,48195511,4357512,83572170,23120642,54853060,9575809,86449625,
			99995293,16049762,58456240,97551793,70403797,71275770,42703689,86408211,55487823,31994065,96295364,57046217,95412217,37718369,72813609,80221456,1737671,31657108,91682559,7903833,94500640,37597632,41210725,64213901,24418157,44666234,51282775,31885678,5571474,31555646,73655076,78473330,9028711,86958044,32710798,91365297,92687919,7742785,34576633,15820759,67883282,81579347,47449425,15089510,27963315,85642256,91117259,96842655,89401293,58000933,98465819,74947683,20714298,23383734,36907056,60877848,59623588,79941680,2648477,3726913,43875194,78598565,25612598,23091655,6020923,51740496,47982363,3920718,7691207,72769057,64234577,47474706,13572456,53223592,35494672,97528625,30667859,9109369,16217323,85963988,63076781,53059583,55963750,66889279,57784217,93955459,64267737,33473576,41777949,50684925,51398659,36509461,75962363,11656619,82976109,49022598,76199045,96702181,11286867,45911576,76850665,3016108,71201324,92847880,37305747,41808628,53597607,63532112,16788297,97223349,
			94182984,29508821,67872439,64257678,40563364,91578544,24113524,47285212,85492896,47051956,82158323,25790651,79202017,11937190,3718289,19023891,58658479,42172742,87836050,6141372,56652126,23109537,88821525,83543841,78640552,21367040,80180388,66006086,60213844,18124515,90068766,63240317,43028026,68139805,58519382,88561238,32207998,53484232,91885526,81291995,22991979,26218495,14965568,49486547,9575807,59140663,46046929,64725147,14036626,48748662,45404670,65495941,98226739,39485803,12576137,50926941,46499709,63559288,32764347,71393814,32202009,15307763,97884015,47735287,5809736,4395285,52500437,75654102,67556239,56850341,40157596,96992784,12522661,58199740,50413241,44484716,61014749,57788536,92034791,91652242,12130429,78393328,42686304,64454794,83438994,327524,50547885,96386289,24613921,14168478,88215240,33592274,17977642,61202591,84318295,21703558,3762802,5805713,83179051,31014324,93060811,8802527,8005099,1598958,56294757,96029698,27886491,15088083,124936,41218968,
			54069843,24690528,70691621,7312511,15899924,89240,46080784,15379201,91750087,68915361,5849908,35271617,95419231,61375953,90607116,17149932,43324267,89697134,89443231,8030035,52913201,19075588,18147498,22484493,47655292,11657698,76104110,61621230,69040973,50326797,94722741,99556023,20960421,73835258,15342702,81391197,96825987,79969429,59461506,1959103,64889905,78401638,79214877,59420271,12089942,99799767,951533,2847338,71851916,92936124,99817244,17967117,86189293,66338603,68294036,20164412,77591220,56183387,66461523,48932458,30946752,27074642,66988721,82856086,11054134,37312998,32685849,19324981,65930328,25295741,89521965,88080655,91507254,98748013,83005443,92741972,57927355,33345469,30780631,99470373,22937453,12445146,9420199,16887143,82741073,64482522,38179027,36391327,35685633,79754024,47706644,27063183,59207209,13185444,46571522,4209260,25376768,4728025,23456816,15746485,5503081,74025196,47963287,15588863,39103701,71004192,57896518,18101631,67716724,89018056,
			45916691,52814033,58877219,72174739,83465474,63553023,70683537,73516339,44800847,21081553,32339895,45667631,19151880,43396270,41067942,70599469,23736792,42870772,756198,60158739,55628843,44341758,52757573,83992865,45360821,43271709,74241373,6498109,100232,98177934,44457473,39482167,49338450,76384131,4301594,42127769,30958395,97366793,59616825,24890296,80606545,42675088,3582879,39053649,12191305,26709078,58570682,58494838,2456081,47397388,62931286,85314070,17541564,60981679,52979240,36033268,44313046,49996558,15706869,89937323,14474829,78629753,12507116,6198505,34304998,54558732,99343900,41475826,57855131,41456033,93790141,24612296,66610756,91247018,64209881,69999356,43419566,90314848,41662194,36378930,53570745,38758812,79695796,62619874,71024905,6848375,12639529,37121788,12535480,37826568,87595159,82560430,67653585,91207556,70675145,62520231,37499691,45689532,52744320,41705642,20146600,5830258,5180653,56384304,5529605,81628926,60921526,76661271,67780788,35179121,
			21308184,67254787,67890861,13474090,14017293,78385359,4533005,11556612,52519804,23481073,76009576,35147095,72473499,25253467,41158699,56874804,45376951,36854370,92149046,85238283,94968779,69715494,77022378,90492345,66652393,84733753,34884609,56550291,25417672,28426553,31677478,53046133,82647201,20697527,9324126,46723030,77151053,25894467,86253107,96280213,60845248,63702442,72101646,99802100,64465327,41656322,84550210,88924369,43747726,15753226,81136669,88883188,31357876,10961600,43954605,88569917,45065178,58119948,80161588,89744904,27541315,28994415,26094431,29550238,18089551,76030737,68014767,95482584,81783970,8552305,17244472,76878462,46393779,61897295,2681750,22200550,22424171,41314132,68524902,96129923,6761365,47070777,90132135,55680316,95215778,12579545,45871893,89426765,54408501,12075484,7904578,89077265,28417497,19527525,39732645,47372291,80451202,25407890,13447443,1643283,95143458,42996529,84557290,67012505,91639950,60803512,87252612,28452832,23007567,22798701,
			38065209,85847368,62359379,43054094,60729914,71144999,974126,86500666,70238228,81819243,8925451,72322635,78859716,99683999,33537218,81773415,12123215,89331078,36087679,76963754,47601159,95150621,92136362,62243763,14366570,81286763,5863856,44911870,16083526,83502153,13840954,76814891,65538120,67146220,78579794,83499735,43558269,10418250,97290946,12578476,20201879,56972686,76216606,57889773,1084173,7095248,45926331,41190892,86761249,41524706,18002991,57925783,58033160,97101470,8457862,18776004,25081067,38360331,78295039,43577440,3319254,94225954,66621574,89342046,3849082,53941031,16681063,18860160,51408161,41353154,20189547,41730056,67719305,11752810,30398948,84267772,83095038,40331095,19244454,70061431,64234769,96462018,78988513,17750538,71047855,22900490,93730381,87702029,80482171,64078391,31211397,34185995,40108942,12592305,30257400,44750384,39535918,68107786,84265974,73365132,12357164,27671289,46172438,99032474,6674058,51767111,5214770,66496410,86968239,75067956,10918882,
			90625592,55328617,56173991,44736911,31235091,4795703,85366524,64622485,69868791,42832822,94583619,73093091,45235420,47745026,38761319,83971022,28937408,45927721,42610308,88400545,48163129,22913359,32069122,45355224,86879180,6005693,94491287,47150575,22310779,81482438,36734991,35268479,78209431,34178367,35345155,66971045,1658422,22397134,97854014,57977798,94987841,26031416,79472578,51716445,59472113,30767125,24211556,90458562,32444320,36238765,24636676,88752947,24437741,1099245,19354422,34585525,88086421,62838672,72400633,68565987,75272686,95232949,3655513,16622600,64350885,91369221,64434983,76582862,63887836,85076450,77394409,83928905,24756722,48710710,84882142,7307859,17042402,30110967,74881434,48968577,53572406,16712415,78710619,50707392,66534084,39620652,59562663,30571865,69004642,55591269,36091447,827658,57877072,69755636,10153392,42459988,39906203,87079927,92809309,36727322,87520364,5295731,47812557,79041254,55980379,87356723,96640894,25657717,18583932,76202279,54275626,
			48480970,1529472,39740025,89812927,98488054,25080205,58970639,31073429,3007594,82684890,97119482,57407443,47423174,14683401,12670816,49699460,16517676,58206341,4196679,91856736,95981291,79999169,99853741,42843131,59422069,23712573,29477654,23390529,91234280,28357091,42120702,86606474,20785895,99531221,56984849,66522861,68287969,40108489,60543404,23771821,27694786,71965231,87830934,32561157,37094956,5442078,50782177,78022920,11924911,38148361,1447016,58130029,41447447,89739955,43034838,9272015,73844252,4372270,26667775,99697268,40322607,77391406,96693696,59905392,93627652,87952682,72520953,44134548,61402938,44197057,79788187,42124870,39668146,72612145,68818777,85260342,76949176,8235854,83220673,16242749,24327041,67346852,66513750,16442535,51883196,9252369,19727874,10052730,56895290,18850065,47781348,89198255,14148457,66581948,57620438,29154272,43838616,27429606,95922106,87778402,97340444,65581188,39308183,8342927,86333918,16441939,74975604,69834387,5614653,22566227,34558445,
			53984103,25019426,5245327,69168844,23024581,50829569,78276415,78535106,27422822,82061160,35669577,32046525,87697973,11997188,69840749,44630746,19406894,50443123,1989866,95430703,95557518,66953545,31279703,2004437,65486091,80558792,34447144,88127355,74365716,46316764,72519857,7937704,52509737,14046357,86242627,14392345,68624886,59735131,86893847,84931105,66055282,14895238,74078859,42159258,26319640,44347675,37193190,32573963,28915325,47801381,22189878,51056658,1659084,85559792,70226402,24184763,80605597,53848809,59927940,90152219,23796200,60056358,9864956,38199659,47856385,73359943,22829339,95506268,81646960,51074891,78664591,74341647,56149945,66112205,7196807,17462202,74626629,85986207,97939427,4557883,32271335,78728386,28220997,7706321,79475789,46085123,16376435,8702643,47845231,9418263,31603539,16104546,83078557,98688641,17187717,45008410,53926197,19919033,8689189,47288517,31275517,1484198,53743140,5317643,56584900,44726953,65134562,27018621,43728861,29130401,63735785,5072647,
			83497789,47607811,93055925,28316378,44767227,72157782,11862735,58066131,91587734,75358619,96743608,7353741,60277764,58092109,11018701,85964865,65658119,58818113,21850460,99101787,30597878,44882667,72009965,12629024,58017892,11178489,38101914,22766300,89424211,36578093,31766164,93124651,19195072,73540930,25550121,46962755,58726295,71257217,10102418,27581765,69566210,57737404,14294669,64693189,9702457,31247429,44959256,9750634,62104315,36431216,27787384,28027465,39725381,25593056,56182920,60388662,86047733,30448838,79563716,92636445,15324929,94796266,87823457,95345448,61672479,43445515,73583200,22004532,31160616,87832991,78903175,78463475,76005526,93737126,58011506,1469147,35036340,61396370,12787911,9236947,9596566,93510829,82566566,11979548,68919781,51465202,94968647,95196267,4295703,25196965,9341289,13682587,75969034,67079943,9460938,59125665,22059630,65189741,27185350,89192843,23578934,56423681,3634699,30976478,44718731,4769171,19563571,96709654,92464598,95160682,51611794,74613550,
			64842682,18331791,35953372,82828535,81729657,47014910,46163983,99252293,17561966,28877661,16743815,5189501,79956721,46651090,69118687,5738902,3427873,20736096,21653724,14804784,52337519,54800795,90305078};

	/**
	 * 暂存语法树转换成数组形式的结果
	 */
	private List<StoreNode> temp;
	
//	/**
//	 * 暂存语法树转换成数组形式的结果
//	 */
//	private  SimpleNode[] tempResult;

	/**
	 * 树结点在数组中的下标，按深度遍历时结点出现顺序在数组中编号
	 */
	private int index;


	/**
	 * 求一棵树的结点个数
	 * 
	 * @param node
	 * @return 结点个数
	 */
	private  int getNodeNum(Node node) {
		int num = 1;
		int childnum = node.jjtGetNumChildren();
		if (childnum > 0) {
			for (int i = 0; i < childnum; i++) {
				num += getNodeNum(node.jjtGetChild(i));
			}
		}
		return num;
	}

	/**
	 * 深度优先遍历语法树
	 */
	private SimpleNode dfs(SimpleNode node) {
//		int myindex =index++;
		SimpleNode parent;
//		tempResult[myindex] = node;
		node.setNodeNum(1);
		node.setHashValue(hashArrays[node.getId()]);
		int childnum = node.jjtGetNumChildren();
		for (int i = 0; i < childnum; i++) {
			SimpleNode tempSimpleNode = dfs((SimpleNode) node.jjtGetChild(i));
			node.addHashValue(tempSimpleNode.getHashValue());
			node.addNodeNum(tempSimpleNode.getNodeNum());
		}

		parent = (SimpleNode)node.jjtGetParent();
		StoreNode tempStoreNode;
		if(parent!=null){
			tempStoreNode= new StoreNode(node.jjtGetFirstToken().beginLine,node.jjtGetLastToken().endLine,
					node.getHashValue(),parent.getHashValue() ,node.getNodeNum(),parent.getNodeNum());
			
		}
		else
		{
			//将根节点的父节点的hash值设为0
			tempStoreNode = new StoreNode(node.jjtGetFirstToken().beginLine,node.jjtGetLastToken().endLine,
					node.getHashValue(),0,node.getNodeNum(),node.getNodeNum());
		}
		
		temp.add(tempStoreNode);
		
		return node;
	}

	/**
	 * 将语法树从树型结构转换成数组型结构
	 * 
	 * @param treeRoot
	 * @param defaultCodeFile
	 * @return 相似度值
	 */
	public  void convertTreeToArrays(SimpleNode treeRoot, DefaultCodeFile defaultCodeFile) {
//		int nodenum = getNodeNum(treeRoot);
		temp = defaultCodeFile.getTree();
		//清空原有数据
		temp.clear();
		index = 0;
		dfs(treeRoot);		//前序遍历
		Collections.sort(temp);
	}

}
