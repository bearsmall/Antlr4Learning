## 第二章 纵观全局

>在上一章中，我们安装了ANTLR，了解了如何构建和运行一个简单的示例语法。在本章中，我们
>将壮观全局，学习语言类应用程序相关的重要过程、术语和数据结构。随着学习的深入，我们将
>认识一些关键的ANTLR对象，并简单了解ANTLR在背后帮助我们完成的工作。

### 2.1 从ANTLR源语言开始
>识别语言的程序称为语法分析器（parser）或者句法分析器（syntax analyzer）。句法是指约束语言
>中的各个组成部分之间关系的规则，在本书中，我们会通过ANTLR语法来指定语法的句法。语法（grammar）
>是一系列规则的集合，每条规则表述出一种词汇结构。ANTLR工具能够将其转换为如同经验丰富的开发者手工
>构建一般的语法分析器。ANTLR语法本身又遵循了一种专门用来描述其他语言的语法，我们称之为ANTLR元语言（ANTLR's meta-language）。

* 字符流-》词法分析器-》词法符号流-》语法分析器-》语法树

### 2.2 实现一个语法分析器

>ANTLR工具依据类似于我们之前看到的assign的语法规则，产生一个递归下降的语法分析器（recursive-descent parser)。
>递归下降的语法分析器实际上是若干递归方法的集合，每个方法对应一条规则。下降的过程就是从语法分析树的根结点开始，朝着叶节点（词法符号）
>进行解析的过程。首先调用的规则，即语义符号的起点，就会成为语法分析树的根结点。

* 根据assign规则生成的方法（稍微经过格式整理），用于展示递归下降语法分析器的细节：
```g4
//assign : ID '=' expr ';' ;

void assign(){          //根据assign规则生成的方法
    match(ID);          //将当前的输入符号和ID相比较，然后将其消费掉
    match('=');
    expr();             //通过调用当前方法expr()来匹配一个表达式
    match(';');
}
```
>递归下降语法分析器最神奇的地方在于，通过方法stat()、assign()和expr()的调用描绘出的调用路线图映射到了语法分析树的节点上。
>调用match()对应了语法分析树的叶子节点。在手工构造的语法分析器中，我们需要在每条规则对应的方法的开始位置插入“增加一个新的子树根节点”
>这样的操作，在match()方法中插入“增加一个新的叶子节点”这样的操作。

* 词汇符号除了顺序结构外还可以拥有更多的备选分支
```g4
/**从当前输入位置开始，匹配多种语句 */
stat: assign        // 第一个备选分支（'\' 符号是备选分支的分隔符）
    | ifstat        // 第二个备选分支
    | whilestat
    ...
    ;
```
>stat语法规则对应的switch多条件分支语句
```g4
void stat(){
    switch (《当前输入的词法符号》){
        CASE ID :   assign();   break;
        CASE IF :   ifstat();   break;  //IF是if关键字的词法符号类型
        CASE WHILE: whilestat();break;
        ...
        default :   《 抛出无可选方案的异常 》
    }
}
```

> 为了测试一个语句是不是合法的，我们将这个语句中的单词和迷宫的地板上的单词比较，然后沿着这个语句的单词所描述的路径在迷宫中
> 前进。如果我们能够通过这个语句中的单词序列指定的路径已将到达，那么这个语句就是合法的。

### 2.3 你再也不能往核反应堆多加水了

> 歧义性语句是指存在不止一种语义的语句，换句话说，歧义性语句中的单词序列能够匹配多种语法结构。本节中标题“你再也不能往核反应堆多加水了”这句话让人不确定，是已经无法往核反应堆多加水还是不应该往核反应堆多加水。
* 明显的歧义
```g4
stat: ID '=' expr ';'   //匹配一个赋值语句
    | ID '=' expr ';'   //糟糕！重复了前一个备选的分支！
    ;
```
* 微妙的歧义
```g4
stat: expr ';'          //表达式语句，也可以匹配“f();”
    | ID '(' ')' ';'    //函数调用
    ;

expr: ID '(' ')'
    | INT
    ;
```
> 这里有两种方式都可以匹配到f()；
> ANTLR 解决歧义问题的方法是：选择所有匹配的备选分支中的第一条。在上面的例子中，ANTLR将会选择左边的语法分析树作为输入文本“f();”的语义解释。

### 2.4 使用语法分析树来构建语言类应用程序

>

### 2.5 语法分析树监听器和访问器